# Project Sol: 問題生成アルゴリズム レビュー資料

## 1. 現在の問題生成プロセスの概要

### 1.1 全体フロー

```
[1/8] Draft生成 (AI生成)
  ↓
[2/8] Dockerfile検証
  ↓
[3/8] Dockerイメージビルド
  ↓
[4/8] テストコンテナ起動 & 解答可能性検証
  ↓
[5/8] フラグアクセシビリティ確認
  ↓
[6/8] Writeup再生成（実際のコンテナURL使用）
  ↓
[7/8] データベースデプロイ
  ↓
[8/8] SNSコンテンツ生成
```

### 1.2 主要コンポーネント

#### 1.2.1 MissionDrafter (`tools/generation/drafter.py`)
- **役割**: AI（GPT-4o）を使用して問題のJSONを生成
- **入力**: 難易度、カテゴリ、テーマ
- **出力**: 完全な問題JSON（app.py, Dockerfile, requirements.txt, writeup含む）
- **プロンプト**: `_build_system_prompt()`で生成される詳細なプロンプト

#### 1.2.2 ContainerTester (`tools/solver/container_tester.py`)
- **役割**: コンテナの起動と解答可能性の検証
- **機能**:
  - `start_test_container()`: コンテナ起動
  - `test_solvability()`: コンテナが解答可能か検証
  - `stop_test_container()`: コンテナ停止

#### 1.2.3 ProblemSolver (`tools/solver/problem_solver.py`)
- **役割**: 実際に問題を解いてみる（自動エクスプロイト）
- **対応問題タイプ**: SQLi, RCE, LogicError
- **機能**: 各問題タイプに応じた自動解法

## 2. 現在の問題点

### 2.1 RCE問題の具体例

**問題**: `ls`を実行すると`app.py`と`requirements.txt`しか表示されない

**解説の記述**:
```
cat /path/to/flag.txt でフラグを取得できる
```

**実際の問題**:
- フラグファイルが存在しない
- フラグのパスが不明確
- 解説に書かれているパスが実際の環境と一致しない

### 2.2 根本的な問題

1. **フラグの配置場所が不明確**
   - コード生成時にフラグの配置場所が明確に指定されていない
   - Dockerfileでフラグファイルをコピーしていない
   - 環境変数として設定されていない

2. **解説と実際のコードの不一致**
   - 解説は「コードを見るとわかる」と書いているが、解く側はコードを見られない
   - 解説に書かれているパスが実際の環境と一致しない
   - フラグの取得方法が実際には機能しない

3. **検証プロセスの不十分さ**
   - 問題生成時に実際に解けるかどうかを完全に検証していない
   - フラグが実際に取得可能かどうかを確認していない
   - 解説の内容が実際の環境と一致するか確認していない

4. **プロンプトの不備**
   - RCE問題でフラグファイルを配置する方法が明確に指示されていない
   - フラグの配置場所に関する制約が不足している
   - 解く側の視点での問題設計が不十分

## 3. 改善提案

### 3.1 フラグ配置の標準化

**提案**: フラグの配置場所を明確に定義し、すべての問題タイプで統一する

**オプション1: 環境変数方式（推奨）**
```python
import os
FLAG = os.getenv('CTF_FLAG', 'SolCTF{default_flag}')
```

**オプション2: ファイル方式**
```dockerfile
# Dockerfile
COPY flag.txt /home/ctfuser/flag.txt
ENV CTF_FLAG_FILE=/home/ctfuser/flag.txt
```

**オプション3: コード埋め込み方式（LogicError等）**
```python
FLAG = 'SolCTF{...}'
```

### 3.2 RCE問題の特別な要件

**提案**: RCE問題では、フラグを確実に取得できるようにする

1. **フラグファイルの配置**
   ```dockerfile
   # Dockerfile
   RUN echo "SolCTF{...}" > /home/ctfuser/flag.txt
   # または
   COPY flag.txt /home/ctfuser/flag.txt
   ```

2. **フラグの表示方法**
   - `cat /home/ctfuser/flag.txt` で取得可能にする
   - または `env | grep FLAG` で取得可能にする
   - または `/flag` エンドポイントで取得可能にする

3. **検証プロセス**
   - 生成後に実際に `cat /home/ctfuser/flag.txt` を実行してフラグが取得できるか確認
   - 解説に書かれているコマンドが実際に動作するか確認

### 3.3 プロンプトの改善

**提案**: System Promptに以下を追加

1. **フラグ配置の明確な指示**
   - RCE問題: フラグファイルを `/home/ctfuser/flag.txt` に配置
   - SQLi問題: フラグをデータベースまたは環境変数に配置
   - LogicError問題: フラグをコード内に埋め込み

2. **解く側の視点での問題設計**
   - 解く側はコードを見られない
   - 解く側が見える情報のみで問題が解けるようにする
   - フラグの取得方法が明確であること

3. **検証可能な解説**
   - 解説に書かれているコマンドが実際に動作すること
   - 解説に書かれているパスが実際の環境と一致すること

## 4. 監督者AIとの相談用プロンプト

---

# 監督者AIへの相談: CTF問題生成システムの改善

## 背景

Project Solは、CTF問題を自動生成するシステムです。現在、以下の問題が発生しています：

1. **RCE問題**: `ls`を実行すると`app.py`と`requirements.txt`しか表示されない。解説には「`cat /path/to/flag.txt`でフラグを取得できる」と書かれているが、実際にはフラグファイルが存在しない。

2. **解説と実際のコードの不一致**: 解説は「コードを見るとわかる」と書いているが、解く側はコードを見られない。解説に書かれているパスが実際の環境と一致しない。

3. **検証プロセスの不十分さ**: 問題生成時に実際に解けるかどうかを完全に検証していない。

## 現在のシステム構成

### 問題生成フロー
1. **Draft生成**: AI（GPT-4o）が問題のJSONを生成（app.py, Dockerfile, requirements.txt, writeup含む）
2. **Dockerfile検証**: ユーザー作成などの基本的な検証
3. **Dockerイメージビルド**: 問題をコンテナ化
4. **テストコンテナ起動**: コンテナを起動して動作確認
5. **解答可能性検証**: `ProblemSolver`が実際に問題を解いてみる
6. **Writeup再生成**: 実際のコンテナURLを使用して解説を再生成
7. **データベースデプロイ**: 問題をデータベースに登録

### 主要コンポーネント
- **MissionDrafter**: AIを使用して問題を生成
- **ContainerTester**: コンテナの起動と検証
- **ProblemSolver**: 実際に問題を解いてみる（SQLi, RCE, LogicError対応）

## 質問事項

### Q1: フラグ配置の標準化

**問題**: 現在、フラグの配置場所が問題タイプごとに異なり、不明確です。

**質問**: 
- RCE問題では、フラグをどのように配置すべきですか？
  - オプション1: ファイル方式（`/home/ctfuser/flag.txt`）
  - オプション2: 環境変数方式（`CTF_FLAG`）
  - オプション3: その他

- すべての問題タイプで統一すべきですか？それとも問題タイプごとに最適な方法を選ぶべきですか？

### Q2: RCE問題の特別な要件

**問題**: RCE問題で、`ls`を実行してもフラグファイルが見えない。

**質問**:
- RCE問題では、フラグを確実に取得できるようにするために、どのような要件が必要ですか？
  - フラグファイルを必ず配置する？
  - フラグのパスを固定する（例: `/home/ctfuser/flag.txt`）？
  - 複数の方法で取得可能にする？

### Q3: プロンプトの改善

**問題**: 現在のSystem Promptでは、フラグの配置方法が明確に指示されていません。

**質問**:
- System Promptに、フラグ配置に関する明確な指示を追加すべきですか？
- どのような形式で指示すべきですか？（例: 「RCE問題では、フラグファイルを `/home/ctfuser/flag.txt` に配置すること」）

### Q4: 検証プロセスの強化

**問題**: 問題生成時に、実際に解けるかどうかを完全に検証していません。

**質問**:
- 検証プロセスをどのように強化すべきですか？
  - フラグが実際に取得可能か確認する？
  - 解説に書かれているコマンドが実際に動作するか確認する？
  - 解く側の視点で問題が解けるか確認する？

### Q5: 解説生成の改善

**問題**: 解説に「コードを見るとわかる」と書かれているが、解く側はコードを見られません。

**質問**:
- 解説生成時に、解く側の視点で解説を生成するにはどうすべきですか？
  - コード内の変数名を解説に含めない？
  - 実際にブラウザで見える情報のみを基に解説を生成する？
  - 推測や試行錯誤のプロセスを含める？

## 期待する回答

1. **具体的な改善案**: 上記の質問に対する具体的な回答
2. **実装の優先順位**: どの改善を優先すべきか
3. **リスク評価**: 各改善案のリスクと対策
4. **追加の提案**: 上記以外の改善案があれば

---

## 5. 実装チェックリスト

### 5.1 即座に実装すべき項目

- [ ] System Promptにフラグ配置の明確な指示を追加
- [ ] RCE問題でフラグファイルを必ず配置するように修正
- [ ] 検証プロセスでフラグが実際に取得可能か確認
- [ ] 解説生成時に解く側の視点で解説を生成

### 5.2 中期的に実装すべき項目

- [ ] フラグ配置の標準化（すべての問題タイプで統一）
- [ ] 検証プロセスの自動化強化
- [ ] 問題生成時の自動修正機能

### 5.3 長期的に検討すべき項目

- [ ] 問題の難易度に応じたフラグ配置方法の最適化
- [ ] 複数の解法をサポートする問題設計
- [ ] 問題の品質評価システム

