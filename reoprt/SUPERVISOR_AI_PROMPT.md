# 監督者AIへの相談プロンプト

以下のプロンプトを監督者AIに送信してください。

---

# CTF問題生成システムの改善に関する相談

## システム概要

Project Solは、CTF問題を自動生成するシステムです。以下の技術スタックを使用しています：

- **言語**: Python 3.11+
- **AI**: OpenAI GPT-4o（問題生成と解説生成）
- **コンテナ**: Docker（問題の実行環境）
- **フレームワーク**: Flask（Webアプリケーション）

## 現在の問題

### 問題1: RCE問題でフラグが取得できない

**症状**:
- RCE問題を生成した
- `ls`を実行すると`app.py`と`requirements.txt`しか表示されない
- 解説には「`cat /path/to/flag.txt`でフラグを取得できる」と書かれている
- しかし、実際にはフラグファイルが存在しない

**影響**:
- 問題が解けない
- 解説が不正確
- ユーザーが混乱する

### 問題2: 解説と実際のコードの不一致

**症状**:
- 解説に「コードを見るとわかる」と書かれている
- しかし、解く側はコードを見られない（ソースコードは公開されていない）
- 解説に書かれているパスが実際の環境と一致しない

**影響**:
- 解説が役に立たない
- 問題が解けない
- ユーザーの信頼を損なう

### 問題3: 検証プロセスの不十分さ

**症状**:
- 問題生成時に実際に解けるかどうかを完全に検証していない
- フラグが実際に取得可能かどうかを確認していない
- 解説の内容が実際の環境と一致するか確認していない

**影響**:
- 解けない問題がデプロイされる
- 品質の低い問題が生成される

## 現在のシステム構成

### 問題生成フロー

```
[1/8] Draft生成 (AI生成)
  ├─ MissionDrafter: GPT-4oが問題のJSONを生成
  ├─ 入力: 難易度、カテゴリ、テーマ
  └─ 出力: 完全な問題JSON（app.py, Dockerfile, requirements.txt, writeup含む）

[2/8] Dockerfile検証
  └─ ユーザー作成などの基本的な検証

[3/8] Dockerイメージビルド
  └─ 問題をコンテナ化

[4/8] テストコンテナ起動 & 解答可能性検証
  ├─ ContainerTester: コンテナを起動
  └─ ProblemSolver: 実際に問題を解いてみる（SQLi, RCE, LogicError対応）

[5/8] フラグアクセシビリティ確認
  └─ フラグが取得可能か確認（現在は不十分）

[6/8] Writeup再生成
  └─ 実際のコンテナURLを使用して解説を再生成

[7/8] データベースデプロイ
  └─ 問題をデータベースに登録

[8/8] SNSコンテンツ生成
  └─ マーケティング用コンテンツを生成
```

### 主要コンポーネント

#### MissionDrafter (`tools/generation/drafter.py`)
- **役割**: AI（GPT-4o）を使用して問題のJSONを生成
- **プロンプト**: `_build_system_prompt()`で生成される詳細なプロンプト（約1200行）
- **制約**: セキュリティ基準、Dockerfile制約、Flask制約、デザイン要件など

#### ContainerTester (`tools/solver/container_tester.py`)
- **役割**: コンテナの起動と解答可能性の検証
- **機能**:
  - `start_test_container()`: コンテナ起動
  - `test_solvability()`: コンテナが解答可能か検証
  - `stop_test_container()`: コンテナ停止

#### ProblemSolver (`tools/solver/problem_solver.py`)
- **役割**: 実際に問題を解いてみる（自動エクスプロイト）
- **対応問題タイプ**: SQLi, RCE, LogicError
- **機能**: 各問題タイプに応じた自動解法

## 質問事項

### Q1: フラグ配置の標準化

**現状**: フラグの配置場所が問題タイプごとに異なり、不明確です。

**質問**: 
1. RCE問題では、フラグをどのように配置すべきですか？
   - オプション1: ファイル方式（`/home/ctfuser/flag.txt`）
   - オプション2: 環境変数方式（`CTF_FLAG`）
   - オプション3: その他（推奨方法があれば）

2. すべての問題タイプで統一すべきですか？それとも問題タイプごとに最適な方法を選ぶべきですか？

3. フラグの配置場所を固定する（例: `/home/ctfuser/flag.txt`）べきですか？それとも問題ごとに変えるべきですか？

### Q2: RCE問題の特別な要件

**現状**: RCE問題で、`ls`を実行してもフラグファイルが見えません。

**質問**:
1. RCE問題では、フラグを確実に取得できるようにするために、どのような要件が必要ですか？
   - フラグファイルを必ず配置する？
   - フラグのパスを固定する（例: `/home/ctfuser/flag.txt`）？
   - 複数の方法で取得可能にする？

2. `ls`でフラグファイルが見えるべきですか？それとも隠すべきですか？

3. フラグの取得方法を複数用意すべきですか？（例: `cat /home/ctfuser/flag.txt`, `env | grep FLAG`, `/flag`エンドポイント）

### Q3: プロンプトの改善

**現状**: 現在のSystem Promptでは、フラグの配置方法が明確に指示されていません。

**質問**:
1. System Promptに、フラグ配置に関する明確な指示を追加すべきですか？
   - どのような形式で指示すべきですか？（例: 「RCE問題では、フラグファイルを `/home/ctfuser/flag.txt` に配置すること」）
   - どのセクションに追加すべきですか？

2. 問題タイプごとに異なる指示を追加すべきですか？

3. フラグ配置に関する制約を追加すべきですか？（例: 「フラグは必ず取得可能でなければならない」）

### Q4: 検証プロセスの強化

**現状**: 問題生成時に、実際に解けるかどうかを完全に検証していません。

**質問**:
1. 検証プロセスをどのように強化すべきですか？
   - フラグが実際に取得可能か確認する？
   - 解説に書かれているコマンドが実際に動作するか確認する？
   - 解く側の視点で問題が解けるか確認する？

2. 検証に失敗した場合、どのように処理すべきですか？
   - 問題を修正する？
   - 問題を再生成する？
   - エラーとして報告する？

3. 検証プロセスをどの段階で実行すべきですか？
   - 問題生成後？
   - コンテナ起動後？
   - デプロイ前？

### Q5: 解説生成の改善

**現状**: 解説に「コードを見るとわかる」と書かれているが、解く側はコードを見られません。

**質問**:
1. 解説生成時に、解く側の視点で解説を生成するにはどうすべきですか？
   - コード内の変数名を解説に含めない？
   - 実際にブラウザで見える情報のみを基に解説を生成する？
   - 推測や試行錯誤のプロセスを含める？

2. System Promptに、解説生成に関する制約を追加すべきですか？
   - どのような制約を追加すべきですか？
   - どのセクションに追加すべきですか？

3. 解説の検証プロセスを追加すべきですか？
   - 解説に書かれているコマンドが実際に動作するか確認する？
   - 解説に書かれているパスが実際の環境と一致するか確認する？

## 期待する回答

1. **具体的な改善案**: 上記の質問に対する具体的な回答
2. **実装の優先順位**: どの改善を優先すべきか
3. **リスク評価**: 各改善案のリスクと対策
4. **追加の提案**: 上記以外の改善案があれば
5. **コード例**: 可能であれば、改善案のコード例

## 制約事項

- Python 3.11+を使用
- Dockerコンテナで実行
- セキュリティ基準: 非root実行（ctfuser）、ポート8000のみ公開
- 単一ファイル原則: app.py 1つのファイルにすべてを含む
- 外部テンプレートファイル禁止

## 参考資料

- 現在のSystem Prompt: `tools/generation/drafter.py` の `_build_system_prompt()` メソッド
- 問題生成フロー: `tools/cli.py` の `cmd_auto_add()` 関数
- 検証プロセス: `tools/solver/container_tester.py` の `test_solvability()` メソッド

---

**このプロンプトを監督者AIに送信し、回答を得てください。**

